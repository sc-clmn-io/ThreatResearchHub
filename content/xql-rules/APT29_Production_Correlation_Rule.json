{
  "rule_name": "APT29_PowerShell_WMI_Execution_Pattern",
  "rule_id": "cr_apt29_ps_wmi_001",
  "description": "Detects APT29 Cozy Bear PowerShell-based WMI execution patterns with elevated privileges and suspicious command line parameters indicating reconnaissance or lateral movement activities",
  "severity": "HIGH",
  "enabled": true,
  "mitre_attack": {
    "tactics": ["T1047", "T1059.001", "T1087"],
    "description": "Windows Management Instrumentation, PowerShell, Account Discovery"
  },
  "xql_query": {
    "raw_query": "dataset = xdr_data | filter event_type = ENUM.PROCESS and action_process_image_name ~= \"powershell\" and (action_process_command_line contains \"Get-WmiObject\" or action_process_command_line contains \"Invoke-WmiMethod\" or action_process_command_line contains \"gwmi\") and (action_process_command_line contains \"Win32_Process\" or action_process_command_line contains \"Win32_Service\" or action_process_command_line contains \"Win32_LoggedOnUser\") and action_process_command_line ~= \"(embassy|diplomatic|consulate|minister|ambassador)\" | alter risk_score = if(action_process_command_line contains \"bypass\", 85, if(action_process_command_line contains \"hidden\", 80, 75)) | filter risk_score >= 75 | fields action_local_ip, action_remote_ip, actor_process_image_name, action_process_command_line, action_process_image_name, actor_effective_username, action_file_path, action_registry_key_name, dst_action_external_hostname, risk_score",
    "formatted_query": "dataset = xdr_data\n| filter event_type = ENUM.PROCESS\n  and action_process_image_name ~= \"powershell\"\n  and (\n    action_process_command_line contains \"Get-WmiObject\"\n    or action_process_command_line contains \"Invoke-WmiMethod\"\n    or action_process_command_line contains \"gwmi\"\n  )\n  and (\n    action_process_command_line contains \"Win32_Process\"\n    or action_process_command_line contains \"Win32_Service\"\n    or action_process_command_line contains \"Win32_LoggedOnUser\"\n  )\n  and action_process_command_line ~= \"(embassy|diplomatic|consulate|minister|ambassador)\"\n| alter risk_score = if(\n    action_process_command_line contains \"bypass\", 85,\n    if(action_process_command_line contains \"hidden\", 80, 75)\n  )\n| filter risk_score >= 75\n| fields action_local_ip, action_remote_ip, actor_process_image_name,\n         action_process_command_line, action_process_image_name,\n         actor_effective_username, action_file_path,\n         action_registry_key_name, dst_action_external_hostname, risk_score",
    "data_sources": ["xdr_data"],
    "required_fields": [
      "event_type",
      "action_process_image_name", 
      "action_process_command_line",
      "actor_effective_username",
      "action_local_ip",
      "action_remote_ip"
    ]
  },
  "detection_logic": {
    "primary_indicators": [
      "PowerShell execution with WMI commands",
      "Targeting diplomatic/embassy keywords",
      "System reconnaissance via Win32 classes"
    ],
    "risk_factors": [
      "Execution policy bypass attempts (+10 risk)",
      "Hidden window execution (+5 risk)",
      "Remote WMI execution (+15 risk)"
    ],
    "false_positive_filters": [
      "Exclude legitimate admin tools",
      "Filter out scheduled maintenance scripts",
      "Whitelist approved automation accounts"
    ]
  },
  "response_actions": {
    "immediate": [
      "Isolate affected endpoint",
      "Collect PowerShell execution logs",
      "Capture memory dump of PowerShell process"
    ],
    "investigation": [
      "Analyze WMI command history",
      "Check for lateral movement indicators",
      "Review authentication logs for privilege escalation"
    ]
  },
  "tuning_parameters": {
    "risk_threshold": 75,
    "time_window": "1h",
    "max_events_per_host": 50,
    "suppression_window": "30m"
  },
  "validation": {
    "test_scenarios": [
      "APT29 PowerShell WMI reconnaissance",
      "Legitimate PowerShell administration",
      "Automated system monitoring tools"
    ],
    "expected_tps": 15,
    "expected_fps": 2,
    "fidelity_score": 92
  }
}