commonfields:
  id: 9f87efe7-6b16-4b22-877a-08861684e742
  version: 55
vcShouldKeepItemLegacyProdMachine: false
name: displayDefenderHostStatus_xsiam
script: "# This is a helper script designed to be used with the \"[BETA] MSGraph Endpoint
  Alert Layout\". This populates a dynamic section of the layout with the most current
  host record,\n# as extracted from the Microsoft Defender for Endpoint integration,
  using the microsoft-atp-get-machine-details command\n\ndef main():\n    try:\n        context_data
  = demisto.alert()\n        full_context = demisto.context()\n        agent_id =
  context_data['CustomFields']['agentid']\n\n\n        try:\n            machine_action
  = full_context['MicrosoftATP']['MachineAction'] #[-1]['Type'] #full_context['MicrosoftATP']['MachineAction'][-1]['Type']\n
  \           if isinstance(machine_action, list):\n                last_action_type
  = machine_action[-1]['Type']\n                last_action_time = machine_action[-1]['CreationDateTimeUtc']\n
  \           else:\n                last_action_type = machine_action['Type']\n                last_action_time
  = machine_action['CreationDateTimeUtc']\n\n        except Exception as e:\n            last_action_type
  = \"None\"\n\n        if last_action_type == \"Isolate\":\n            last_action
  = \"\U0001F6AB Isolate (UTC: \" + last_action_time + \")\"\n        elif last_action_type
  == \"Unisolate\":\n            last_action = \"\U0001F7E2 Unisolate (UTC: \" + last_action_time
  + \")\"\n        else:\n            last_action = \"None\"\n\n        # Note, this
  has not been implemented or tested yet. Just a placeholder.\n        host_record
  = execute_command('microsoft-atp-get-machine-details', {'machine_id': agent_id})\n
  \       last_seen = host_record[0]['lastSeen']\n        risk_score = host_record[0]['riskScore']\n
  \       if risk_score == \"Low\":\n            risk_score = \"\U0001F7E2 Low\"\n
  \       elif risk_score == \"Medium\":\n            risk_score = \"\U0001F7E1 Medium\"\n
  \       elif risk_score == \"Informational\":\n            risk_score = \"\U0001F535
  Informational\"\n        elif risk_score == \"High\":\n            risk_score =
  \"\U0001F534 High\"\n        else:\n            risk_score = \"\U0001F7E4 Unknown
  or None\"\n\n        # All of this needs to be re-written based on MSFT Machine
  details format\n        host_name = host_record[0]['computerDnsName']\n        host_status
  = host_record[0]['healthStatus']\n        if host_status == \"Active\":\n            host_status
  = \"\U0001F7E2 Active\"\n        elif host_status == \"Misconfigured\":\n            host_status
  = \"\U0001F7E1 Misconfigured\"\n        elif host_status == \"Inactive\":\n            host_status
  = \"\U0001F534 Inactive\"\n        else:\n            host_status = \"\U0001F7E4
  Unknown or Offline\"\n\n        host_current_local_ip = host_record[0]['lastIpAddress']\n
  \       host_current_external_ip = host_record[0]['lastExternalIpAddress']\n        host_os
  = host_record[0]['osPlatform']\n        host_snippet = \"Hostname: \" + host_name
  + \"\\n\" + \"MDE Risk Score: \" + risk_score + \"\\n\" + \"MDE Status: \" + host_status
  + \"\\n\" + \"Last XSIAM Action: \" + last_action + \"\\n\" + \"Last Seen: \" +
  last_seen + \"\\n\" + \"Current Local IP: \" + host_current_local_ip + \"\\n\" +
  \"Current External IP: \" + host_current_external_ip + \"\\n\" + \"OS: \" + host_os\n
  \       return_results(host_snippet)\n\n    except Exception as e:\n        error_statement
  = \"\U0001F534 There has been an issue gathering host status. Please ensure the
  Microsoft Defender for Endpoint automation integration is enabled, and please verify
  that agentid exists and is populated in the issue/alert context. Check WarRoom for
  more details.\\n\"\n        error_statement += \"\\n\\n\\n\\n\\n\\nException thrown:
  \" + str(e)\n        return_results(error_statement)\n\nif __name__ in (\"builtins\",
  \"__builtin__\", \"__main__\"):\n    main()"
type: python
tags:
- dynamic-section
enabled: true
scripttarget: 0
subtype: python3
pswd: ""
runonce: false
dockerimage: demisto/python3:3.12.8.1983910
runas: DBotWeakRole
engineinfo: {}
mainengineinfo: {}
